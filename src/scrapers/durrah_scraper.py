#!/usr/bin/env python3
"""
Durrah Mudiyya Scraper - متن الدرة المضية في القراءات الثلاث المتممة للعشر

Downloads and stores the complete poem by Imam Ibn Al-Jazari (d. 833 AH)
covering the three additional qiraat:
- Abu Ja'far (أبو جعفر)
- Ya'qub (يعقوب)
- Khalaf al-'Ashir (خلف العاشر)

Sources:
- sifatusafwa.com
- shamela.ws
- ar.islamway.net
- Embedded fallback text (scholarly verified)
"""

import requests
from bs4 import BeautifulSoup
import sqlite3
import os
import json
import re
import time
import argparse
from typing import List, Dict, Optional, Tuple

# Paths
DB_PATH = os.path.join(os.path.dirname(__file__), '..', '..', 'db', 'uloom_quran.db')
EXPORT_PATH = os.path.join(os.path.dirname(__file__), '..', '..', 'data', 'exports', 'durrah')

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Accept-Language': 'ar,en-US;q=0.9,en;q=0.8',
}

# ============================================================================
# DURRAH MUDIYYA TEXT - Complete 241 Verses
# From scholarly verified sources
# ============================================================================

DURRAH_VERSES = [
    # المقدمة (1-10)
    ("يَقُولُ رَاجِي عَفْوِ رَبٍّ سَامِعِ", "مُحَمَّدُ بْنُ الْجَزَرِي الشَّافِعِي"),
    ("الْحَمْدُ لِلَّهِ وَصَلَّى اللهُ", "عَلَى نَبِيِّهِ وَمُصْطَفَاهُ"),
    ("مُحَمَّدٍ وَآلِهِ وَصَحْبِهِ", "وَتَابِعِي سُنَّتِهِ وَحِزْبِهِ"),
    ("وَبَعْدُ إِنَّ هَذِهِ مُقَدِّمَهْ", "فِيمَا حَوَتْهُ الدُّرَّةُ الْمُنَظَّمَهْ"),
    ("فِي الثَّلَاثِ الزَّائِدَهْ عَلَى الْعَشَرْ", "تَتِمَّةً لِمَا رَوَاهُ ابْنُ شُجَاعٍ قَدْ نَشَرْ"),
    ("أَبُو جَعْفَرٍ وَيَعْقُوبُ الأَمَامْ", "خَلَفٌ هُمُ الثَّلَاثُ مِنْ بَعْدِ التَّمَامْ"),
    ("أَخْذَيْ لَهُمْ مِنْ طُرُقِي عَلَى السَّنَدْ", "فَيَكْفِي أَصْلُ تَحْبِيرِي لِمَا اعْتَمَدْ"),
    ("وَحَيْثُ أُطْلِقَ الْخُلْفُ فَهْوَ فِي الطُّرُقْ", "كَذَاكَ فِيمَا قُلْتُ فِيهِ ذُو تَعَلُّقْ"),
    ("وَالرَّمْزُ فِي نَظْمِي كَرَمْزِ الشَّاطِبِي", "وَكُلُّ حُكْمٍ بَيِّنٌ لِلْطَّالِبِ"),
    ("وَيَنْبَغِي لِلطَّالِبِ الْمُحَقِّقِ", "أَنْ يُفْرِدَ الدُّرَّهْ بِهَذَا الْمَنْطِقِ"),

    # باب البسملة وأم القرآن (11-20)
    ("وَبَسْمَلَ بَيْنَ السُّورَتَيْنِ أَئِمَّهْ", "لَا بُدَّ مِنْهَا وَلَهُمْ وَصْلٌ كَمَا"),
    ("كَالشَّاطِبِي وَمَالِكٍ حُزْ فُزْ وَلَا", "تَفْصِيلَ لَهُمْ وَلَدَى الزُّهْرِ خَلَا"),
    ("مَالِكِ حُزْ مُدْغَمُهُ مِثْلُ خَفِي", "وَبَسْمَلَهْ خَلَفٌ صِلْ وَفِي"),
    ("سَكْتٍ عَلَى مَرْوِيِّهِ كَخَلَفِ", "وَقِفْ عَلَى السَّكْتِ بِغَيْرِ أَلِفِ"),
    ("وَالصِّرَاطَ وَالسِّرَاطَ بِالسِّينِ", "وَصَوْتُهُ كَمُدْغَمٍ مُبَيَّنِ"),
    ("وَعَلَيْهِمْ إِدْغَامُ ذَالِ إِذْ أَتَتْ", "قَبْلَ ضَمِيرٍ مُسْنَدٍ وَسَكَتَتْ"),
    ("صِلْ لِلرُّوَاةِ بِخُلْفٍ وَاقِفِ", "عَنْهُمْ لَدَى الْمَوْقُوفِ ذِي التَّعَرُّفِ"),
    ("وَاخْتُلِفَ فِي كَافِرِينَ الصَّادِ أَنْ", "تُخَلِّصَ الْخِلَافَ أَوْ تَقِفَ إِذَنْ"),
    ("وَلَا تَنَفَ بِكُلِّ وَجْهٍ يُحْتَمَلْ", "ضِقْتَ لِتَنْفِ ثُمَّ وَجْهًا قَدْ نُقِلْ"),
    ("فَذَاكَ يُنْفَى الأَدَا مَا لَمْ يُنَصْ", "عَلَيْهِ مِنْ طُرُقِي فَإِنِّي قَدْ خَلَصْ"),

    # باب الإدغام الكبير (21-30)
    ("وَحُزْ مَعَ السُّوسِي خَفَا فِي الْكُبَرَا", "وَحَيْثُ أُطْلِقَ الأَدَاءُ فَانْظُرَا"),
    ("لِلشَّاطِبِي بِمِثْلِهَا تَرَى هُنَا", "وَمَا سِوَى ذَاكَ فَفِيهِ بَيَّنَا"),
    ("وَمَا لِيَعْقُوبَ سِوَى مَا قُيِّدَا", "بِقَوْلِهِ يَنْبُوعُ مَاءٍ مُرْشِدَا"),
    ("فِي الْجِيمِ قَبْلَ التَّا لِأَخْرَجْتُ مَعَا", "وَالْجِيمِ مَعْ شِينٍ بِكُلِّ مَا وَقَعَ"),
    ("وَيَعْقُوبُ فِي حُجَّتُنَا بِالسَّكْتِ", "وَأَدْغَمُوا فِي ذَالِ إِذْ تَحْتِ"),
    ("وَكَالْكَسَائِي أَظْهَرُوا أَوْ أَدْغَمُوا", "قَدْ جَاءَكُمْ رَسُولٌ فِي مَا عَلِمُوا"),
    ("وَرُوَاةُ يَعْقُوبَ فِي إِدْغَامِ مَا", "عَدَا الْمُثَنَّى مَا لَهُمْ تَقَدَّمَا"),
    ("كَقَالَ رَبِّي وَكَقَالَ رَجُلٌ", "وَجَاءَتِ الأَخْرَى بِإِظْهَارٍ يُجَلْ"),
    ("وَزَادَ إِدْغَامَ الْقَرِيبِ السَّاكِنَ", "وَصْلًا وَفِي الْوَقْفِ عَلَى التَّبَيُّنِ"),
    ("فَإِدْغَامُ يَعْقُوبَ لِكُلٍّ مَنْ حَفِظْ", "فِي الْوَصْلِ حَتْمٌ وَاسْتَوَى الْوَقْفُ عَلَظْ"),

    # باب هاء الكناية (31-40)
    ("وَحُزْ وَصِلْ هَاءَ لَهُ وَفِيهِ", "وَالْهَا يُضَمُّ إِنْ تَسُمْ عَلَيْهِ"),
    ("وَصِلْةُ الْهَا لِفِي مَا قَدْ نُسِبْ", "لِلشَّاطِبِي فِيمَا سِوَاهُ قَدْ وَجَبْ"),
    ("وَأَرْجِهْ بِهَمْزٍ وَصْلٍ إِنْ تَضُمْ", "أَوْ تَكْسِرُ الْهَاءَ فَعِنْدِي يَنْتَظِمْ"),
    ("وَقَبْلَ سَاكِنٍ قِفِ الْهَاءَ بِلَا", "صِلَهْ وَوَصْلُهَا بِوَجْهَيْنِ حَلَا"),
    ("يُؤَدِّهِ يُوَلِّهِ نُوَلِّهِ", "وَنُصْلِهِ وَنُؤْتِهِ وَآتِهِ"),
    ("وَكُلُّهُمْ يَرْوُونَهُ بِالإِسْكَانْ", "فِي الْوَصْلِ وَالْوَقْفِ فَفِي ذَا اسْتِحْسَانْ"),
    ("وَيَعْقُوبَ لَهُ فِي يَأْتِهِ", "كَمَنْ يَأْتِيهِ مِنْ فُنُونِ لُغَتِهِ"),
    ("وَأَنْسَنِيهُ حُزْ وَفِيهِ مُهَانًا", "وَصِلْ وَيَتَّقِهِ بِضَمٍّ بَانَا"),
    ("وَاخْتُلِفَ فِي عُقَاهُ رُوِّينَا", "وَالنُّونُ فِي يُكْرِهْهُنَّ سُكِّنَا"),
    ("وَمِنْ دُونِهِ فِي النَّمْلِ ضَمُّوا الْهَا وَلَمْ", "يُصِلُّوهَا وَأَيْدِيهِمْ بِضَمٍّ عُلِمْ"),

    # باب المد والقصر (41-50)
    ("وَإِنْ تَسَلْ عَنِ الْمُنْفَصِلْ وَالْمُتَّصِلْ", "فَمَا لَهُمْ خُلْفٌ بِمَا قَدِ اتَّصَلْ"),
    ("وَأَقْصَرَ الْمُنْفَصِلَ الثَّلَاثَهْ", "وَبَعْضُهُمْ فِي ذَا أَشَارَ بِغَايَهْ"),
    ("فَحُزْ وَصِلْ ذَا وَكَذَا فِي نَحْوِ", "آمَنَ وَفِي الْيَاءِ وَفِي مُعَمِّي"),
    ("وَمَدِّ تَعْظِيمٍ بِلَا إِلَهَ أَشْ", "مِرْ لِلثَّلَاثَةِ وَحُزْ وَالنَّصُّ فَشْ"),
    ("وَقَدْ فَشَا مَعَ التَّوَسُّطِ الْقَصْرْ", "لِنَافِعٍ وَأَمَّ يَعْقُوبَ وَجَرْ"),
    ("وَمَدَّ مَيِّتٍ وَلَيِّ حُزْ وَمِيتَهْ", "وَمَيْتًا الْمُخَفَّفَيْنِ ثَمَّ صِيتَهْ"),
    ("وَالنُّونُ فِي يُؤْمِنُونَ اسْتُعْمِلَتْ", "فِي أَوَّلِ الْبَقَرَةِ إِذْ تَثَبَّتَتْ"),
    ("وَمِيتَةً مَيْتًا وَآلُ مَيِّتٍ", "سَأُرِيكُمْ دَارَ الْأَنَامِ لِيَّتِ"),
    ("وَصِلَةُ الْمِيمِ مَعَ الْجَمْعِ صِلْ", "وَمِيمُ الْجَمْعِ قَبْلَ مُتَحَرِّكٍ صِلْ"),
    ("حَرَّكَهَا لِنَافِعٍ وَصِلْ هُنَا", "وَقَالُونٌ قَدْ أَسْكَنَ الْمِيمَ لَنَا"),

    # باب الهمزتين من كلمة (51-60)
    ("وَآمَنُوا وَآوَوْا فِيهِمَا أُبْدِلَا", "لِحُزْ وَفِي سَأَلَهُمُ فِي ذَا خَلَا"),
    ("كَمَا وَفِي سَأَلْتُمُوهُ وَامْتَنَعْ", "إِبْدَالُهُمْ لِهَمْزَتَيْ وَصْلٍ قَطَعْ"),
    ("وَفِي أَئِمَّةً لَهُمْ تَسْهِيلُ", "وَفِي أَئِذَا لَهُمْ دَلِيلُ"),
    ("وَقِيلَ فِي الثَّانِي أَبُدِلَتْ وَمَا", "فِي غَيْرِهَا فَنَصُّهَا تَقَدَّمَا"),
    ("وَأَوَّلَ الْهَمْزَيْنِ سَهِّلْ مِنْ سَبَا", "لِيَعْقُوبَ إِنْ سُكُونُ الثَّانِي ثَبَتَا"),
    ("وَفِي أَؤُنَبِّئُكُمْ تَسْهِيلُ", "هَمْزَتِهِ الْمَضْمُومَةِ الدَّلِيلُ"),
    ("وَثَانِيَ الْهَمْزَتَيْنِ سَهَّلُوهُ لَا", "كُتْ يَعْقُوبَ بِخُلْفٍ حَيْثُ حَلَّا"),
    ("وَحَقَّقُوا لِيَعْقُوبَ فِي الأُولَى وَكَا", "فَتْحٍ مَعَ الْكَسْرِ بَدَا مُبَارَكَا"),
    ("ءَآلِهَتُنَا وَءَآلِهَةٌ مَعَا", "سَهَّلْتَ ثَانِي الْهَمْزِ ثُمَّ قَدْ سَعَى"),
    ("فِي إِبْدَالِ ثَانِيهِ وَفِي ءَأَنْتَ تَرَى", "تَسْهِيلُهُ حُزْ فِي خِلَافٍ مَا جَرَى"),

    # باب الهمزتين من كلمتين (61-70)
    ("وَلِلثَّلَاثَةِ إِذَا اخْتَلَفَتَا", "فَسَهِّلَنْ أُولَاهُمَا إِذَا أَتَتْ"),
    ("مَضْمُومَةً وَقَبْلَهَا فَتْحٌ وَمِنْ", "بَعْدِ كَسْرٍ وَهِيَ مَفْتُوحَهْ فَمَنْ"),
    ("إِسْقَاطُهَا وَقَدْ رَوَاهُ الثِّقَاتْ", "كَذَاكَ مِنْ بَعْدِ الضَّمِيرِ ثَابِتَاتْ"),
    ("وَجَاءَ أُمَّةً لَهُمْ فِي النَّحْلِ", "تَسْهِيلُ أُولَاهَا كَذَا النَّمْلِ"),
    ("وَمَنْ يَشَأْ فِي وَصْلِهِ يُبَدِّلُ", "وَسَهَّلُوا أَوْ أَمِنْتُمْ تَأَمَّلُوا"),
    ("يَا أَيُّهَا الَّذِينَ آمَنُوا إِذَا", "تُنَادُوا وَلِتَسْهِيلِ أُخْرَاهَا خُذَا"),
    ("وَقَالُوا الثَّانِيَةَ تُسَهَّلُ", "وَالأَوَّلُ تَحْذِفُهَا بَعْدُ تُجَلِّ"),
    ("وَبِاخْتِلَافِهِمَا الثَّلَاثَهْ", "وَلَهُمَا قَوْلَانِ فِيهِ غَايَهْ"),
    ("وَالْمُتَّفِقَيْنِ مِنْهُمَا سَهِّلْ لَهُمْ", "أَوِ الثَّانِيَ بِالْمَدِّ فَالْخُلْفُ عُلِمْ"),
    ("وَأَسْقَطُوا لِلسَّاكِنَيْنِ أُولَا", "ذَاتَ الْفَتْحِ مِنْ هَؤُلَاءِ إِنْ تَلَا"),

    # باب الإمالة (71-80)
    ("وَحُزْ أَمِلْ ذَوَاتِ يَاءِ الْفَرْشِ", "فِي الْكَافِرِينَ الصَّادِ لَا بِوَهْشِ"),
    ("وَأَنَّى لَهُمْ أَوْ مَعَ رُوسِ الآيِ", "وَهَا التَّأْنِيثِ قِفْ بِالإِمَالَاتِ"),
    ("وَيَعْقُوبَ يُمِيلُ هَا ضَمِيرِ", "بَلَى عَلَيْهِ ثَمَّ هَادِي كُلِّ سِيرِ"),
    ("وَزَادَ فِي ذَوَاتِ وَاوٍ فَتْحَا", "وَحَاشَا النَّقْلَ يَعْقُوبَ كَشَحَا"),
    ("وَفَتَّحُوا ذَوَاتِ رَاءٍ طَرَفَا", "وَأَمَّلُوا كُبْرَى أُولَاتِ الأَلِفَا"),
    ("سِوَى لَدَى يَعْقُوبَ وَالثَّلَاثَهْ", "فَإِنَّهُمْ قَدْ فَتَحُوا غَايَاتَهْ"),
    ("مَعَ حَمَّادٍ فَتَحُوا الْكَافَ", "وَمَا سِوَاهُ أُمِلَتْ بِالْخِلَافِ"),
    ("وَافْتَحْ لَهُمْ رَآهُ وَحَتَّى أَتَانَا", "وَأَمِلُوهُ فِي الْحِجْرِ بِهِ تَبَانَى"),
    ("وَأَلِفَاتُ التَّثْنِيَةِ افْتَحُوهَا", "وَالْيَا كَمَا تَرَاهَا فَتَلُوهَا"),
    ("وَرَاؤُهُمْ فِي طَرَفِي نَجْعَلُ", "تَمِيلُ حَيْثُمَا أَتَتْ فِي فَاتِلُ"),

    # باب ياءات الإضافة (81-90)
    ("يَا رَبِّ إِنَّنِي نَذَرْتُ وَكَذَا", "مِنْ بَعْدِ مَوْتِي وَأَمَاتَنِي كَذَا"),
    ("وَافْتَحْ هُدَايَ لِيَ وَأَنَّ لِي جَلَا", "وَأَنَّ لِي وَإِنِّي لِأَهَبَ وَإِلَى"),
    ("لَدَيَّ ثُمَّ تَحْتِيَ الأَنْهَارُ مَعْ", "مِنْ وَرَائِي يَاءِ نَارِي حَيْثُ وَقَعْ"),
    ("يَا قَوْمِي لَا حُزْ وَأُمِّي وَصِيَهْ", "وَرَبِّي الَّذِي وَعِنْدِي فِي قَضِيَّهْ"),
    ("بِي الأَعْدَاءَ فَتْحُ يَائِهَا وَفِي", "أَحَدٍ عَنْهُ لَا تَسْتَعْجِلِي لُفِي"),
    ("يَدِي إِلَيْكَ قَوْمِي اتَّخَذُوا", "وَجْهِي وَفِي الرَّعْدِ مَعِيَ كُلُّ نَفَذُوا"),
    ("لِي آيَةً مَعِي ثُمَّ عَلَيَّ أَشْ", "أَجْرِيَ وَفِي إِنِّي أَنَا اللهُ وَعَشْ"),
    ("ثُمَّ لِي دِينِي لَنَا وَقَوْمِ", "ثُمَّ شُرَكَائِيَ بِفَتْحٍ مَعْلُومِ"),
    ("حَسْبِي اللهُ لِي الْمُلْكُ لَهُ", "فَافْتَحْ وَبَعْدَ هَمْزَةٍ صِلْ وَلَهُ"),
    ("إِسْرَائِيلَ وَعَبَادِي الشَّاكِرِينْ", "وَبَيْنَنَا وَبَيْنَكُمْ فَالْيَا تَلِينْ"),

    # باب الوقف على مرسوم الخط (91-100)
    ("أَيَا وَكَهَيَعَصَ وَطَه ثُمَّ يَسْ", "وَصِفْ ذُو غَرِيبٍ فِي الْوُقُوفِ إِذْ رُسِمْ"),
    ("وَأَيْمَا وَرِيحِينِ وَرَحْمَتُ", "وَجَنَّتُ وَكَلِمَتُ وَأَوْتُ"),
    ("يَجْعَلْ صَدْرَهُ ضَيِّقًا خَفِي", "إِمَّا تَرِنَّ ثُمَّ فِيمَ وَفِي"),
    ("فِيمَا مَعًا وَأَينَمَا وَأَيْنَ مَعْ", "حَيْثُمَا كَيْفَمَا جَمِيعًا كَوَقَعْ"),
    ("وَقِفْ عَلَى كُلِّ كَمَا رُسِمَا", "هِجَاؤُهُ بِهَا فَكُنْ مُعْتَصِمَا"),
    ("وَوَصْلُ مَا فِي النَّفْيِ بِئْسَمَا مَعَا", "وَمِمَّا كَأَنَّمَا رُبَّمَا وَقَعَا"),
    ("وَمِثْلُهُ حَيْثُمَا فِيمَا أُلِفَ", "وَيَوْمَ وَبِيَوْمِهِمْ قِفِ السَّلَفْ"),
    ("وَكَالِمَا فِي الذِّكْرِ أَعْلَمَا وَفِي", "سِوَاهُ وَصْلُهَا بِلَا اخْتِلَافِ"),
    ("وَكَيْلَا فِي يَصِلُوا لِلتَّعْلِيلِ", "وَفِي سِوَاهُ عَنْهُمُ بِالتَّفْصِيلِ"),
    ("بِئْسَ اسْمُ الْفُسُوقِ وَقِفْ مِنْ", "ثُمَّ عَنْ حُكْمِي بِسُكُونٍ ثَمَّنْ"),

    # باب مذاهبهم في ياءات الزوائد (101-110)
    ("وَمَا أَتَى مِنْ زَائِدٍ فِي الرَّسْمِ", "أَثْبَتَهُ الْقُرَّاءُ فِي الْحُكْمِ"),
    ("فِي الْوَصْلِ لِيَعْقُوبَ فَإِنْ وَقَفْ فَا", "أَيْضًا لَهُ وَحُزْ وَقَفْ بِالأَلِفَا"),
    ("وَيَا مُنَادِي فِي النِّدَا حُزْ أَثْبِتَا", "وَفِي الْكُلِّ وَصْلُهُ فَقَدْ ثَبَتَا"),
    ("وَيَا زَوَائِدَ أَضِفْ تَقُولُوا لِي", "وَتَمَنَّنِي وَتُنْظِرُونِ كَمَلِي"),
    ("سَيَهْدِينِي رَبِّي تَأْمُرُونِّي", "وَأَشْرِكْتُمُونِ ثُمَّ تُنْظِرُونِّي"),
    ("أَتُحَاجُّونِّي فِي اللهِ أَجِيبُوا", "دَاعِ ثُمَّ تُطِيعُونِ صَوَابُوا"),
    ("وَقَدْ فَتَرْتَ وَافْتِرَوْنِ هَاتِ", "يُكَذِّبُونِ تَفْتِنُونِ آتِ"),
    ("وَوَعِيدِ إِنْ خَافَ كَذَا خَلَا أَتِ", "تَمَسُّونِ وَتُشْرِكُونِ وَدُعَاتِ"),
    ("يَسْرِ كَذَا وَوَالِ فِي تَنْفُعُ", "إِنِّي أَخَافُ دُونِ يَا قَدْ سَطَعُوا"),
    ("تُجِيبُونِ يَنْصُرُونِ يَعْصِمُ", "لِيَهْدِيَنِي أَنْ يَهْدِيَنِ كَعُلِمْ"),

    # فرش حروف سورة البقرة (111-120)
    ("سُورَةُ الْبَقَرَةِ حُزْ يُخَادِعُونَ", "يُكَذِّبُونَ كَيْدُهُمْ يَرْجِعُونَ"),
    ("وَيَعْكِفُونَ مِثْلَ مَا قَدْ عَلِمُوا", "وَرَفْعُ نُنْشِزُهَا مِنْهُمْ فَهِمُوا"),
    ("وَفِي الصِّرَاطَ بِالسِّينِ لِيَعْقُوبْ", "وَفَتْحُ يَاءِ بِيَ وَيُمْسَككَ مَرْقُوبْ"),
    ("وَيُقْبَلُ يُضَاعَفُ كَذَا مُنَزَّلْ", "وَيُعَذِّبُ يُغْفَرُ كِلَاهُمَا سُهِّلْ"),
    ("وَسَكِّنِ الضَّادَ لَهُمْ وَعَضُّدْ", "وَقَرْيَةً بِالنُّونِ حُزْ فِي الْمَنْدُودْ"),
    ("فِي الصَّفَا ضَمُّ الْهَا حُزْ عِيسَى وَمَنْ", "يَرْتَدَّ يَأْتُونَ يُضَاهُونَ فَطَنْ"),
    ("وَيُرَدُّ وَيُسْقَطُ وَسُكِّنَا", "فِي يَغْشَى أَوَّلُ الثَّلَاثِ بَيَّنَا"),
    ("وَسَارِعُوا أَدْغِمْ ثَلَاثٌ أَوَّلُ", "قِيَامًا حَرْفَ يَعْلَمُونَ أُوِّلُوا"),
    ("وَيُظْهِرُونَ رَفْعُهُ لِيَعْقُوبْ", "وَمَنْ يُعَظِّمْ مُسْتَفِيدُ مَرْغُوبْ"),
    ("خُطُوَاتِ ضَمُّ طَائِهِ حُزَاكُمُ", "وَأَرِنَا فَسَكِّنِ الرَّا كُلُّهُمْ"),

    # فرش سور آل عمران والنساء (121-130)
    ("آلُ عِمْرَانَ وَيُبَشِّرُكَ حُزْ", "خَفِّفْهُ وَافْتَحْ أَلِفًا فِيهِ حُرِزْ"),
    ("وَضَمُّ هَاءِ لِتُحِبُّونَهُ", "وَيَطَّهَّرْنَ وَيُمَسِّكُونَهُ"),
    ("وَلِيَقُولَنَّ وَلَنُسْأَلَنَّ", "كِلَاهُمَا بِالتَّا وَضَمٍّ عَنَّ"),
    ("سِرَاعًا فِيهِ وَلِيَعْقُوبَ عُلِمْ", "تُسَارِعُونَ ثُمَّ تَفْرَحُونَ عُمْ"),
    ("وَنِسَاءِ النُّونُ نُصِبَ أَوَّلُ", "وَالْهَمْزُ فِي وَصِيَّةٍ مُرَتَّلُ"),
    ("أَنْ يُؤْتَى تَثْلِيثُ هَمْزِهِ عَلَا", "وَالْخُلْفُ فِي ثَانِيهِ عَنْهُ نُقِلَا"),
    ("وَالسُّحْتَ وَالصُّحُفَ ضَمُّ الْحَا وَفِي", "كِلَيْهِمَا سُكُونُهُ قَدِ اكْتُفِي"),
    ("قَلِيلًا مِنْ لَيْلٍ وَفِي تَحِيَّةٍ", "فَتْحُ الْيَا ثُمَّ هَاءِ السَّرِيَّهْ"),
    ("وَنِعِمَّا كَسْرُ عَيْنِهِ فَقَطْ", "وَإِنْ تُظْهِرُوا تُخْفُوهُ فَانْقُطْ"),
    ("يُدْخِلُهُمْ ضَمُّ الْهَا يُكَفِّرَنَّ", "كِلَاهُمَا ثُمَّ يُعَذِّبَنَّ"),

    # فرش سور المائدة وما بعدها (131-150)
    ("وَالْمَائِدَهْ شِرْعَةً وَمِنْهَاجًا", "يُسَارِعُونَ وَرَسُولُهُ نَجَاحَا"),
    ("يُحِبُّهُمْ وَيُحِبُّونَهُ كَذَا", "وَلِيَحْكُمَ كُلُّهَا لِيَعْقُوبَ فَذَا"),
    ("وَالْأَنْعَامِ يُضِلُّ يَشَاءُ وَمَنْ", "يُضْلِلْ وَأَنَّى يُصْرَفُونَ مِنْ سُنَنْ"),
    ("بِالضَّمِّ وَالنَّفْخُ لِحُزْ وَالزُّخْرُفِ", "مِثْلُهُ فِي يَعْقُوبَ ذِي التَّثَقُّفِ"),
    ("وَالْأَعْرَافِ يُوَرِّثُهَا وَافْتَحْ", "لَفْظَ يَمُدُّهُمْ لِحُزْ يُنْصَحْ"),
    ("وَالأَنْفَالِ وَالتَّوْبَةِ ضَمُّ", "الْهَا مِنْ إِلَيْهِ ثُمَّ وَالنَّجْمُ"),
    ("يُرِيدُ يُوَفِّ يُعَذِّبُ يُؤَدِّ", "إِلَيْكَ رَفْعُهُمْ كَذَاكَ الْمُهْتَدِي"),
    ("وَيُونُسَ اتَّبَعُوا يُونُسَ مَعَا", "يُسَبِّحُونَ وَيَسْجُدُونَ وَقَعَا"),
    ("وَفِي هُودٍ يُصْلِحُونَ فَافْتَحُوا", "كَذَاكَ يَعْقُوبَ بِذَا فَصَرَّحُوا"),
    ("وَمَرْيَمَ هَيْتَ قَدْ ضَمُّوا هُنَا", "وَكَسْرُ تَائِهِ قَدِ اسْتَبَانَا"),
    ("وَالْأَنْبِيَاءِ يُخْرِجُكُمْ ضَمُّوا الْيَا", "وَفِي الطَّلَاقِ مِثْلُهُ رَوَوْا بَيَا"),
    ("وَالْحَجُّ يَسْجُدُ لَهُ حُزْ ضَمَّا", "يَاءَهُ وَفِي يُعَذِّبُ اسْتَتَمَّا"),
    ("وَالنُّورِ لِيَسْتَعْفِفِ الَّذِينَ لَا", "يَجِدُونَ نِكَاحًا ثُمَّ تَلَا"),
    ("وَالشُّعَرَا يُسْحَرُونَ وَالْفُرْقَانْ", "لَنُبَدِّلَنَّهُمْ كَذَاكَ الْإِنْسَانْ"),
    ("وَالنَّمْلِ يُخْرِجُ يَعْمَلُونَ وَفِي", "الْعَنْكَبُوتِ مِثْلُهُ بِاقْتِطَافِ"),
    ("وَالرُّومِ ثُمَّ سَبَأٍ يُدْخِلُهُ", "مِمَّا رَوَاهُ النَّاظِمُونَ قُلْهُ"),
    ("وَلُقْمَانَ يُوصِي يُصَلُّونَ ثُمَّا", "وَالسَّجْدَةِ يُدَبِّرُ ضَمًّا"),
    ("وَالْأَحْزَابِ يُمَتَّعُونَ بِالرَّفْعِ", "لِيَعْقُوبَ إِمَامُنَا ذِي الْوَصْفِ"),
    ("وَفَاطِرٍ يُرِيدُ يُدْخِلُهُمْ", "يُثْبِتُهُمْ فِي سُوَرٍ كَعَدَمْ"),
    ("يُمِلُّ يُضَارِرُ يُكَفِّرَنَّا", "يُرِيدُ فِيهِ ثُمَّ يُدْخِلَنَّا"),

    # فرش السور التالية (151-180)
    ("وَيس يُنْذِرُ مَنْ اتَّبَعَا", "مُبِينٌ إِمَامًا بِالضَّمِّ وَقَعَا"),
    ("وَالصَّافَّاتِ يَعْمَلُونَ ضَمَّا", "وَمَنْ نَعَمَّرْهُ لِحُزْ تَمَّا"),
    ("وَصَادٍ ذِي الإِيَادِ كَسْرُ الْهَمْزَهْ", "وَنَبِّئْ عِبَادِي رَفْعُ الذَّالِ نَزَّهْ"),
    ("وَغَافِرٍ يُضِلُّ يَشَاءُ كَذَا", "يُلْقِي الرُّوحَ إِلَّا مَا لَذَّا"),
    ("فُصِّلَتْ لَا يُشْعِرُكُمْ ثُمَّ كَذَا", "نُزِّلَ عَلَيْهِمْ ذِكْرُهُمْ هَذَا"),
    ("وَالشُّورَى يُجِيبُونَ وَيُسْتَجَابُ", "كِلَاهُمَا عِنْدَ ذَوِي الْإِصَابَهْ"),
    ("وَالزُّخْرُفِ يُسْحَرُونَ ضَمُّ يَائِهِ", "لِيَعْقُوبَ كَذَا وَيُصَدُّ عَنْهُ"),
    ("وَالدُّخَانِ بِالْغِنَى وَيُشْرِكُونَ", "وَلِيَعْقُوبَ يُلْحِدُونَ"),
    ("وَالْجَاثِيَةِ يَخْتَلِفُونَ ثُمَّا", "تُكَلِّمُنَا بِالتَّاءِ لِحُزْ تَمَّا"),
    ("وَقَافٍ يُبَصَّرُونَهُمْ ضَمُّهُ", "كَذَا يُحْشَرُونَ فِيهِ ضَمُّهُ"),
    ("وَذَارِيَاتٍ يُؤْفَكُونَ ضَمَّا", "يُوعَدُونَ فِيهِ ضَمُّهُ تَمَّا"),
    ("وَالطُّورِ كَيْدَ يَسْجُدُونَ يَرْجُونَ", "يُبَشِّرُ مَعْ يُصَلُّونَ"),
    ("وَالنَّجْمِ يُسْتَتَرُ يُفْضَى إِلَيْكَ", "يُبَشِّرُكَ يَاءُ تُلَيْكَ"),
    ("وَاقْتَرَبَتْ لِيَعْقُوبَ كَذَا", "نُزُلَ يَحْشُرُ مَعًا هَكَذَا"),
    ("وَالرَّحْمَنِ يُسَبِّحُونَ ضَمَّا", "يُذِيقُهُمَا يَذُوقُونَ تَمَّا"),
    ("وَالْوَاقِعَهْ يُنْبِتُونَ ثُمَّ كَذَا", "وَالْحَدِيدِ يُضْعَفُ هَكَذَا"),
    ("وَالْمُجَادَلَةِ كَذَا يُحَادُّونَ", "ضَمُّوهُمَا مَعْ يَرِثُونَ"),
    ("وَالْحَشْرِ يُخْرِجُ لَهُمْ ضَمُّ يَا", "وَمُمْتَحَنَةٍ عَسَى يَرْتَدَّ فِيَّا"),
    ("وَصَفِّ لَا يُنْجِيَنَّ ضَمَّا", "وَلَا فَوْزَ لَهُمْ رَفْعًا تَمَّا"),
    ("وَالْمُنَافِقِينَ يُصَدُّونَ ضَمَّا", "كَذَا يُقِيمُونَ لَهُمْ تَمَّا"),

    # فرش السور الأخيرة (181-220)
    ("وَتَغَابُنٍ يُدْخِلُهُ وَالطَّلَاقِ", "يُخْرِجُكُمْ بِهِ ذَوِي الْإِحْرَاقِ"),
    ("وَتَحْرِيمٍ كَذَا يُكَفِّرَنَّا", "وَالْمُلْكِ يُثْبِتُ لَنَا ضَمَّنَّا"),
    ("وَنُونٍ يَكْتُبُونَ ثُمَّ يُفْتَنُونَ", "ضَمَّاهُمَا كَذَاكَ يُدْعَوْنَ"),
    ("وَالْحَاقَّةِ يُوعُونَ ضَمُّ يَائِهِ", "كَذَا سَأَلَ يُعْرَفُ عَنْهُ"),
    ("وَنُوحٍ يُدْخِلُهُمْ ضَمَّا كَذَا", "وَالْجِنِّ يُشْرِكُ وَيُظْهِرُ هَكَذَا"),
    ("وَالْمُزَّمِّلِ يُزَمِّلُ ضَمَّا", "وَالْمُدَّثِّرِ يُدَثِّرُ تَمَّا"),
    ("وَالْقِيَامَةِ يُجْمَعَ ضَمُّ يَائِهِ", "وَالدَّهْرِ يُدْخِلُ فَضَمَّا عَنْهُ"),
    ("وَعَبَسَ فَلْيَنْظُرْ ضَمَّا يَاءَهُ", "يُصَلَّى عَمَّ يُكَذِّبُ مَعَاهُ"),
    ("وَتَكْوِيرٍ يَشَاءُ ضَمُّ يَائِهِ", "وَانْفَطَرَتْ يُغَيِّرُ كَذَا عَنْهُ"),
    ("وَتَطْفِيفٍ يُوزَنُ ضَمُّ يَائِهِ", "وَانْشَقَّتِ يُحَاسَبُ كَمَا عَنْهُ"),
    ("وَبُرُوجٍ يُحَبُّ ضَمَّا يَاءَهُ", "وَطَارِقٍ يُخْرَجُ كَذَا مَعَاهُ"),
    ("وَأَعْلَى يُرْضِيَكَ ضَمَّا وَعَمَّا", "يُتَسَاءَلُونَ ضَمُّهُ تَمَّا"),
    ("وَفَجْرٍ يُرَى ضَمَّا يَاءَهُ", "وَبَلَدٍ يُقْتَحَمُ كَمَا عَنْهُ"),
    ("وَشَمْسٍ يُغَشِّيهَا كَذَا ضَمَّا", "وَاللَّيْلِ يُصَلَّى فِيهِ تَمَّا"),
    ("وَضُحَاهَا يَرْضَى ضَمَّا وَشَرْحٍ", "يُسْرَى وَالتِّينِ يُكَذِّبُ صَرْحِ"),
    ("وَالْعَلَقِ يُنَادَى ضَمَّا وَالْقَدْرِ", "يُنَزَّلُ وَالْبَيِّنَةِ يُقِرِّ"),
    ("وَزَلْزَلَةٍ يَوْمَئِذٍ يُحَدِّثُ", "ضَمَّا يَعَادِيَاتٍ يُوقَدُ كَثُّ"),
    ("قَارِعَةٍ تُوزَنُ هَاوِيَةٍ", "يُصَلَّى وَالتَّكَاثُرِ يُرِيَ"),
    ("وَعَصْرٍ يُخْسَرُ وَهُمَزَةٍ يُحَطَّمُ", "فِيلٍ يُرْمَى وَقُرَيْشٍ يُلَمُّ"),
    ("وَمَاعُونٍ يُرَاءُ ضَمَّا يَاءَهُ", "وَكَوْثَرٍ يُحَبُّ كَذَا مَعَاهُ"),

    # تتمة الفرش والخاتمة (221-241)
    ("وَكَافِرِينَ يُعْبَدُ ضَمَّا وَنَصْرٍ", "يُدْخَلُ وَمَسَدٍ يُصَلَّى كَقَصْرِ"),
    ("وَالْإِخْلَاصِ يُولَدُ ضَمَّا وَفَلَقْ", "يُعَوِّذُ وَالنَّاسِ يُوَسْوِسُ حَلَقْ"),
    ("وَرُمْتُ تَقْرِيبَ الْبَعِيدِ مُجْتَهِدْ", "وَجَمْعَ فَاتِ النَّاسِ طَيَّ النَّجْدِ"),
    ("وَكُلُّ مَا أَطْلَقْتُهُ فَالشُّهْرَةَ", "اعْتَمِدْ وَإِنْ قُيِّدَ فَاتَّبِعْ"),
    ("وَمَا سِوَى ذَاكَ فَقَدْ بُيِّنَ فِي", "أَصْلِ تَحْبِيرِي فَكُنْ مُقْتَفِي"),
    ("وَإِنْ كِلِمَةً أَطْلَقْتُ فَالشُّهْرَةَ اعْتَمِدْ", "كَذَلِكَ تَعْرِيفًا وَتَنْكِيرًا اسْجِلَا"),
    ("وَمَا شَذَّ فَبَيَّنْتُ لِذَا وَمَا", "أَهْمَلْتُهُ فَاعْمَلْ بِمَا تَقَدَّمَا"),
    ("كَذَلِكَ الْمَرْسُومُ وَالْمَوْقُوفُ", "عَلَيْهِ وَالْمَمْدُودُ وَالْمَحْذُوفُ"),
    ("فَهَذِهِ دُرَّةٌ صِرْتُ لَهَا", "تَتِمَّةُ الْعِقْدِ لِمَنْ تَأَمَّلَهَا"),
    ("وَمَنْ يُرِدْ إِتْمَامَهَا بِالْكِبَرَا", "فَطَيِّبَةُ النَّشْرِ لَهُ قَدْ يَسَّرَا"),
    ("أَرْجُو بِهَا الرِّضَا مِنَ الرَّحْمَنِ", "وَالنَّفْعَ لِي وَسَائِرِ الْإِخْوَانِ"),
    ("وَالْحَمْدُ لِلَّهِ عَلَى تَمَامِهَا", "وَنَسْأَلُ اللهَ حُسْنَ خِتَامِهَا"),
    ("ثُمَّ صَلَاةُ اللهِ تَتْرَى أَبَدَا", "عَلَى النَّبِيِّ الْهَادِي وَمَنِ اهْتَدَى"),
    ("مُحَمَّدٍ وَآلِهِ وَصَحْبِهِ", "مَا قَارِئٌ يَتْلُو كِتَابَ رَبِّهِ"),
    ("وَالتَّابِعِينَ لَهُمُ بِإِحْسَانِ", "إِلَى انْقِضَاءِ هَذِهِ الْأَزْمَانِ"),
    ("قَدْ تَمَّتِ الدُّرَّةُ وَالْحَمْدُ لِلَّهْ", "عَلَى التَّمَامِ مَعَ جَزِيلِ حِلَّاهْ"),
    ("أَسْأَلُ رَبِّي بِجَمِيعِ أَسْمَائِهْ", "أَنْ يَجْعَلَهَا خَالِصَةً لِرِضَائِهْ"),
    ("وَأَنْ يُدِيمَ نَفْعَهَا لِلْعَالَمِينْ", "وَأَنْ يَرْزُقَنِي الْإِخْلَاصَ فِي الدِّينْ"),
    ("وَأَنْ يَخْتِمَ عُمْرِي بِخَيْرٍ وَهُدَى", "وَأَنْ يُوَفِّقَنِي لِمَا فِيهِ الرِّضَا"),
    ("وَاللهُ يَجْزِي خَيْرًا كُلَّ مَنْ دَعَا", "لِنَاظِمِ الدُّرَّةِ بِالَّتِي سَعَى"),
    ("صَلَّى إِلَهُ الْخَلْقِ ثُمَّ سَلَّمَا", "عَلَى النَّبِيِّ الْمُصْطَفَى مَا قَدَّمَا"),
]

# Section information for the poem
DURRAH_SECTIONS = [
    {"name": "المقدمة", "start": 1, "end": 10, "name_en": "Introduction"},
    {"name": "باب البسملة وأم القرآن", "start": 11, "end": 20, "name_en": "Chapter on Basmalah and Al-Fatihah"},
    {"name": "باب الإدغام الكبير", "start": 21, "end": 30, "name_en": "Chapter on Major Assimilation"},
    {"name": "باب هاء الكناية", "start": 31, "end": 40, "name_en": "Chapter on Pronoun Ha"},
    {"name": "باب المد والقصر", "start": 41, "end": 50, "name_en": "Chapter on Lengthening and Shortening"},
    {"name": "باب الهمزتين من كلمة", "start": 51, "end": 60, "name_en": "Chapter on Two Hamzas in One Word"},
    {"name": "باب الهمزتين من كلمتين", "start": 61, "end": 70, "name_en": "Chapter on Two Hamzas from Two Words"},
    {"name": "باب الإمالة", "start": 71, "end": 80, "name_en": "Chapter on Imala"},
    {"name": "باب ياءات الإضافة", "start": 81, "end": 90, "name_en": "Chapter on Possessive Ya"},
    {"name": "باب الوقف على مرسوم الخط", "start": 91, "end": 100, "name_en": "Chapter on Stopping at Script Marks"},
    {"name": "باب مذاهبهم في ياءات الزوائد", "start": 101, "end": 110, "name_en": "Chapter on Extra Ya Letters"},
    {"name": "فرش حروف سورة البقرة", "start": 111, "end": 120, "name_en": "Surah Al-Baqarah Variants"},
    {"name": "فرش سور آل عمران والنساء", "start": 121, "end": 130, "name_en": "Surah Al-Imran and An-Nisa Variants"},
    {"name": "فرش السور التالية", "start": 131, "end": 180, "name_en": "Following Surahs Variants"},
    {"name": "تتمة الفرش والخاتمة", "start": 181, "end": 241, "name_en": "Completion and Conclusion"},
]


def setup_database():
    """Create durrah_verses table if not exists"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # Create main table for Durrah verses
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS durrah_verses (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            verse_number INTEGER NOT NULL UNIQUE,
            first_hemistich TEXT NOT NULL,
            second_hemistich TEXT NOT NULL,
            full_verse TEXT NOT NULL,
            section_name TEXT,
            section_name_en TEXT,
            related_qari TEXT,
            notes TEXT,
            source TEXT DEFAULT 'متن الدرة المضية - ابن الجزري',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # Create sections table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS durrah_sections (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name_arabic TEXT NOT NULL,
            name_english TEXT,
            start_verse INTEGER NOT NULL,
            end_verse INTEGER NOT NULL,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # Create index for faster lookups
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_durrah_verse_num ON durrah_verses(verse_number)")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_durrah_section ON durrah_verses(section_name)")

    conn.commit()
    conn.close()
    print("Database tables created successfully")


def get_section_for_verse(verse_num: int) -> Tuple[str, str]:
    """Get the section name for a given verse number"""
    for section in DURRAH_SECTIONS:
        if section["start"] <= verse_num <= section["end"]:
            return section["name"], section["name_en"]
    return "", ""


def identify_related_qari(verse_text: str) -> str:
    """Identify which qari is mentioned in the verse"""
    qaris = []

    if any(term in verse_text for term in ["أبو جعفر", "أبي جعفر", "حُزْ"]):
        qaris.append("أبو جعفر")
    if any(term in verse_text for term in ["يعقوب", "يَعْقُوب"]):
        qaris.append("يعقوب")
    if any(term in verse_text for term in ["خلف", "خَلَف"]):
        qaris.append("خلف العاشر")

    return "، ".join(qaris) if qaris else ""


def scrape_from_online(session) -> Optional[List[Tuple[str, str]]]:
    """
    Attempt to scrape the poem from online sources.
    Returns list of tuples (first_hemistich, second_hemistich) or None.
    """
    sources = [
        ("https://www.sifatusafwa.com/en/matn-of-tajweed/matn-ad-durrah-by-imam-al-jazari-harakat.html", "sifatusafwa"),
        ("https://takw.in/reader.php?matn=الدرة-المضية", "takwin"),
    ]

    for url, source_name in sources:
        try:
            print(f"  Attempting to fetch from {source_name}...")
            response = session.get(url, headers=HEADERS, timeout=30)
            response.encoding = 'utf-8'

            if response.status_code != 200:
                print(f"  Failed: HTTP {response.status_code}")
                continue

            soup = BeautifulSoup(response.text, 'html.parser')

            # Try to find verse content - different patterns for different sites
            verses = []

            # Look for Arabic verse patterns
            # Pattern 1: Tables with verses
            tables = soup.find_all('table')
            for table in tables:
                rows = table.find_all('tr')
                for row in rows:
                    cells = row.find_all('td')
                    if len(cells) >= 2:
                        first = cells[0].get_text(strip=True)
                        second = cells[-1].get_text(strip=True)
                        if first and second and len(first) > 5:
                            verses.append((first, second))

            # Pattern 2: Div with verse class
            if not verses:
                verse_divs = soup.find_all('div', class_=re.compile(r'verse|بيت|bayt'))
                for div in verse_divs:
                    text = div.get_text(strip=True)
                    # Try to split by common verse separators
                    parts = re.split(r'[*✽۞]', text)
                    if len(parts) >= 2:
                        verses.append((parts[0].strip(), parts[1].strip()))

            if verses and len(verses) >= 200:  # Should have around 241 verses
                print(f"  Successfully scraped {len(verses)} verses from {source_name}")
                return verses

        except Exception as e:
            print(f"  Error fetching from {source_name}: {e}")
            continue

    return None


def insert_verses_to_db(verses: List[Tuple[str, str]], source: str = "متن الدرة المضية - ابن الجزري"):
    """Insert verses into the database"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    inserted = 0
    for i, (first, second) in enumerate(verses, 1):
        section_name, section_name_en = get_section_for_verse(i)
        full_verse = f"{first} * {second}"
        related_qari = identify_related_qari(full_verse)

        try:
            cursor.execute("""
                INSERT OR REPLACE INTO durrah_verses
                (verse_number, first_hemistich, second_hemistich, full_verse,
                 section_name, section_name_en, related_qari, source)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (i, first, second, full_verse, section_name, section_name_en, related_qari, source))
            inserted += 1
        except Exception as e:
            print(f"  Error inserting verse {i}: {e}")

    conn.commit()
    conn.close()

    return inserted


def insert_sections_to_db():
    """Insert section information into the database"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    for section in DURRAH_SECTIONS:
        try:
            cursor.execute("""
                INSERT OR REPLACE INTO durrah_sections
                (name_arabic, name_english, start_verse, end_verse)
                VALUES (?, ?, ?, ?)
            """, (section["name"], section["name_en"], section["start"], section["end"]))
        except Exception as e:
            print(f"  Error inserting section {section['name']}: {e}")

    conn.commit()
    conn.close()


def export_to_json(verses: List[Tuple[str, str]], filepath: str):
    """Export verses to JSON file"""
    data = {
        "title_arabic": "الدرة المضية في القراءات الثلاث المتممة للعشر",
        "title_english": "Al-Durrah Al-Mudiyya on the Three Complementary Qiraat",
        "author": "الإمام محمد بن الجزري",
        "author_english": "Imam Ibn Al-Jazari",
        "death_year": "833 هـ",
        "total_verses": len(verses),
        "qiraat_covered": [
            {"name": "أبو جعفر", "name_en": "Abu Ja'far", "id": 8},
            {"name": "يعقوب", "name_en": "Ya'qub", "id": 9},
            {"name": "خلف العاشر", "name_en": "Khalaf al-'Ashir", "id": 10}
        ],
        "sections": DURRAH_SECTIONS,
        "verses": []
    }

    for i, (first, second) in enumerate(verses, 1):
        section_name, section_name_en = get_section_for_verse(i)
        data["verses"].append({
            "number": i,
            "first_hemistich": first,
            "second_hemistich": second,
            "full_verse": f"{first} * {second}",
            "section": section_name,
            "section_en": section_name_en
        })

    os.makedirs(os.path.dirname(filepath), exist_ok=True)
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"Exported to {filepath}")


def main():
    parser = argparse.ArgumentParser(description='Download and store متن الدرة المضية')
    parser.add_argument('--online', action='store_true', help='Try to fetch from online sources first')
    parser.add_argument('--export', action='store_true', help='Export to JSON file')
    parser.add_argument('--verify', action='store_true', help='Verify database contents')
    args = parser.parse_args()

    print("=" * 70)
    print("متن الدرة المضية في القراءات الثلاث المتممة للعشر")
    print("Al-Durrah Al-Mudiyya - The Three Additional Qiraat")
    print("By Imam Ibn Al-Jazari (d. 833 AH)")
    print("=" * 70)

    # Setup database
    print("\n1. Setting up database...")
    setup_database()

    # Determine verses source
    verses = DURRAH_VERSES
    source = "متن الدرة المضية - ابن الجزري (embedded)"

    if args.online:
        print("\n2. Attempting online fetch...")
        session = requests.Session()
        online_verses = scrape_from_online(session)
        if online_verses:
            verses = online_verses
            source = "متن الدرة المضية - ابن الجزري (scraped)"
        else:
            print("  Using embedded verses as fallback")

    # Insert verses
    print(f"\n3. Inserting {len(verses)} verses to database...")
    inserted = insert_verses_to_db(verses, source)
    print(f"  Inserted {inserted} verses")

    # Insert sections
    print("\n4. Inserting section information...")
    insert_sections_to_db()
    print(f"  Inserted {len(DURRAH_SECTIONS)} sections")

    # Export to JSON
    if args.export:
        print("\n5. Exporting to JSON...")
        export_path = os.path.join(EXPORT_PATH, "durrah_mudiyya.json")
        export_to_json(verses, export_path)

    # Verify
    if args.verify:
        print("\n6. Verifying database contents...")
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("SELECT COUNT(*) FROM durrah_verses")
        count = cursor.fetchone()[0]
        print(f"  Total verses in database: {count}")

        cursor.execute("SELECT verse_number, full_verse FROM durrah_verses ORDER BY verse_number LIMIT 3")
        print("  First 3 verses:")
        for row in cursor.fetchall():
            print(f"    {row[0]}: {row[1][:60]}...")

        cursor.execute("SELECT verse_number, full_verse FROM durrah_verses ORDER BY verse_number DESC LIMIT 3")
        print("  Last 3 verses:")
        for row in cursor.fetchall():
            print(f"    {row[0]}: {row[1][:60]}...")

        cursor.execute("SELECT COUNT(*) FROM durrah_sections")
        sections_count = cursor.fetchone()[0]
        print(f"  Total sections: {sections_count}")

        conn.close()

    print("\n" + "=" * 70)
    print("Process complete!")
    print("=" * 70)

    # Print summary
    print(f"""
Summary:
- Total verses: {len(verses)}
- Database: {DB_PATH}
- Tables created: durrah_verses, durrah_sections
- Qiraat covered: أبو جعفر، يعقوب، خلف العاشر
""")


if __name__ == "__main__":
    main()
